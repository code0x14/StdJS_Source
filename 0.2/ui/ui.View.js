/**
 *  Std UI Kit Library
 *  http://ui.stdjs.com
 *  module: view
*/
Std.ui.module("View",{parent:"widget",events:"itemResizeStart itemResizeStop itemSelected clearSelected receive",option:{level:4,defaultClass:"StdUI_View",dots:!1,editable:!0,valueType:"config",background:null,selectionClass:"",itemContextMenu:null,layoutType:"AbsLayout",padding:2},"private":{itemZIndex:0,hasEventBlock:!1,currentItem:null,currentLocker:null,receiving:!1,blockedEvents:"mousedown mouseup mouseover mouseout mouseenter mouseleave click dblclick contextmenu"},initialize:{initDOMTree:function(){var e=this,t=e.opts,n=(e.DOMMap={},{type:e.opts.layoutType,className:"_client",width:null,height:null,initSize:!1,initBoxSize:!1,appendTo:e[0]});t.spacing&&(n.spacing=t.spacing),e._client=Std.ui("layoutWidget",n),t.editable||e._client.addClass("_preview")},initLocker:function(){var e=this,t=e.DOMMap;t.locker=newDiv("_locker").appendTo(e[0]),e[0].on({mouseenter:function(){Std.ui.status.lock||e._receiving||e.receiving(!0)},mouseleave:function(){!Std.ui.status.lock&&e._receiving&&e.receiving(!1)}})},initItemContextMenu:function(e){var t=this,n=null;isArray(e)?n={items:e}:isPlainObject(e)?n=e:isObject(e)&&(n={menu:e}),isObject(n)&&(n.cancel=null,n.check=function(){return t.enable()&&t.editable()}),t._client.plugin("contextMenu",n)},initKeyEvents:function(){var e=this;e[0].on("keydown[del]",function(){if(e.editable()&&e.enable())for(var t=e._selectedItems.length-1;t>=0;t--)e.remove(e._selectedItems[t])}),e[0].on("keydown[Ctrl+A]",function(t){if(e.editable()&&e.enable()){for(var n=0,i=e.itemCount();i>n;n++)e.select(n);t.preventDefault()}}),e[0].on("keydown",function(t){var n=t.which;e.editable()&&e.enable()&&n>=37&&40>=n&&Std.each(e._selectedItems,function(e,t){"AbsLayout"===t.parent().ui&&(38===n?t[0].css("top","-",1):39===n?t[0].css("left","+",1):40===n?t[0].css("top","+",1):37===n&&t[0].css("left","-",1))})})},initResizeEvents:function(){var e=this;e._client.plugin("resize",{items:".StdUI_LayoutItem",handle:".StdUI_LayoutItem > .StdUI_View_ResizeHandle",helper:"original",opacity:1,check:function(t){var n=t.ui(),i=n.item();return e.editable()&&e.enable()?isWidget(i)&&"spacing"===i.ui?!0:"AbsLayout"!=n.parent().ui?!1:void 0:!1}}).on({start:function(t){e.emit("itemResizeStart",[t.self.ui(),t],!0)},stop:function(t){var n=t.self.ui();n.size(t.width,t.height),e.update(),e.emit("itemResizeStop",[n,t],!0)},move:function(e){var t=e.self.ui(),n=t.item(),i=Math.max(t[0].width(),t.minWidth()),o=Math.max(t[0].height(),t.minHeight());t.size(n.opts.width=i,n.opts.height=o),"layout"===t.type()&&t.item().update()}})},initDropEvents:function(){var e=this;e._client.plugin("drop",{items:".StdUI_LayoutItem",placeHolder:"sep",helper:"clone",draggable:!0,originalHelperVisible:!1,activeClass:"StdUI_View_AllowDrop",cancel:null,check:function(t){return e.editable()&&e.enable()&&e.queryContainer(t)},accept:function(t){return e.editable()&&e.enable()&&e.queryContainer(t)}}).on({start:function(e){this.orientation(e.self.ui().parent().orientation)},drag:function(e){var t=e.self.ui();(e.cancel="AbsLayout"!==t.parent().ui||!e.containment)||(t.left(e.positionX),t.top(e.positionY))},enter:function(t){e.dropEnter(this,t)}}).on("sort drop",function(t){var n=t.self.ui(),i=t.item,o=-1;null!=i&&(o=i.ui().index()+("after"===t.side?1:0)),n.parent().remove(n,!1).update(),e.put(n,e.queryContainmentLayout(t.containment),o,t.positionX,t.positionY),e.update()})},initClientEvents:function(){var e=this;e._client[0].on("contextmenu",function(t){e.editable()&&e.enable()&&t.preventDefault()}),e._client[0].on("mousedown",function(t){e[0].focus()&&e._client[0].is(t.target)&&e.clearSelected()}),e._client[0].on("mousedown",".StdUI_LayoutItem",function(t){var n=this.ui();e.editable()&&e.enable()&&e.queryContainer(n)&&(t.ctrlKey?n.selected?e.clearSelected(n):e.select(n):(e.clearSelected(),e.select(n)),t.preventDefault())})},initSelection:function(){var e=this,t=e.DOMMap,n=0,i=0,o=null,l=t.selection=newDiv("_selection "+e.opts.selectionClass),a=function(){Std.css.cursor(null),Std.dom(document).off({mouseup:a,mousemove:c}),e.selectRange(l.css("left"),l.css("top"),l.width(),l.height()),t.selection.detach()},c=function(e){var l=e.pageX-o.x,a=e.pageY-o.y;t.selection.css({left:n>l?l:n,top:i>a?a:i,width:Math.abs(l-n),height:Math.abs(a-i)})};e[0].on("mousedown[1]",function(l){e._client[0].is(l.target)&&e.editable()&&e.enable()&&!Std.ui.status.lock&&(o=e._client[0].offset(),t.selection.appendTo(e[0]).css({left:n=l.pageX-o.x,top:i=l.pageY-o.y,width:0,height:0,zIndex:Std.ui.status.zIndex+1}),Std.css.cursor("default"),Std.dom(document).on({mouseup:a,mousemove:c}))})}},extend:{render:function(){var e=this,t=e.opts;e.initClientEvents(),e.initDropEvents(),e.initResizeEvents(),e.initDropEvents(),e.initKeyEvents(),e.initSelection(),e.initLocker(),e._client.render(),e[0].unselect(!0).on("blur",function(){e.clearSelected()}),t.value&&e.value(t.value),t.itemContextMenu&&e.initItemContextMenu(t.itemContextMenu),e.updateHelpers()},width:function(){var e=this;e.rendered&&e._client.update()},height:function(){var e=this;e.rendered&&e._client.update()},enable:function(e){this.items(function(t,n){n.enable(e)})},remove:function(e){var t=this,n=null;void 0!==e&&(isNumber(e)?n=t.items(e):isObject(e)&&(n=e,e=e.parent()._items.indexOf(e)),n&&isNumber(e)&&e>-1&&(t.clearSelected(n),n.parent().remove(e),t._client.update()))},destroy:function(){var e=this;e.clearEventBlock(),e._client.destroy(),e._selectedItems.clear(),e._currentItem=null}},"protected":{createEventBlock:function(){var e=this;e._hasEventBlock||(Std.each(e._blockedEvents,function(t,n){Std.dom.addEventBlock(n,e._eventBlock)}),e._hasEventBlock=!0)},createLayoutHandle:function(e){for(var t=[],n=[{top:-2,left:0,width:"100%"},{right:-2,top:0,height:"100%"},{bottom:-2,left:0,width:"100%"},{left:-2,top:0,height:"100%"}],i=0;4>i;i++)Std.dom(e).append(t[i]=newDiv("StdUI_View_LayoutHandle").css(n[i]));return t},createItemHandles:function(e){for(var t=(this.clearItemHandles(e),[]),n={"0 6 7":{left:-4},"2 3 4":{right:-4},"0 1 2":{top:-4},"4 5 6":{bottom:-4},"1 5":{left:"50%",marginLeft:-3},"3 7":{top:"50%",marginTop:-3}},i=0;8>i;i++)Std.dom(e).append(t[i]=newDiv("StdUI_View_ResizeHandle"));return Std.each(n,function(e,n){for(var i=0,o=(e=e.split(" ")).length;o>i;i++)Std.dom(t[e[i]]).css(n)}),t},queryContainmentLayout:function(e){var t=null,n=e.ui();return t=n?"layoutItem"===n.ui?n.item():n.layout():e.layout()},queryContainer:function(e){var t=this,n=t._client[0],i=null,o=null,l=".StdUI_LayoutItem";if(!n.contains(e))return null;if(n.is(e=Std.dom(e)))return n;if(e.is(l)){if("layout"===(i=e).ui().type())return i}else{if(o=t.queryContainmentLayout(e))return Std.dom(o.parent());i=Std.dom(e).parent(l)}if(i){if(n.is(o=i.ui().parent()))return n;if(o&&isLayout(o))return Std.dom(o.parent())}return null},dropEnter:function(e,t){var n=this,i="",o=t.containment,l=null;l=o.is(n._client)?n._client.layout():n.queryContainmentLayout(o),l&&(i=l.orientation,e.sortable("AbsLayout"!==l.ui)),i&&e.orientation(i)},receive:function(e,t){var n=this,i=Std.dom(e).plugin("drop",Std.extend({placeHolder:"sep",activeClass:"StdUI_View_AllowDrop",containerItems:".StdUI_LayoutItem",cancel:null,accept:function(e){return n.editable()&&n.enable()&&n.queryContainer(e)}},t));i.on("drop sort",function(e){e.layoutIndex="sort"===e.name?e.item.ui().index()+("after"===e.side?1:0):-1,e.contaimmentLayout=n.queryContainmentLayout(e.containment),n.emit("receive",e),n.updateHelpers(),n.update()}).on({start:function(){n.receiving(!0),this.orientation(n._client.layout().orientation)},enter:function(e){n.dropEnter(this,e)}})},updateHelpers:function(){var e=this,t="StdUI_View_Layout";return e._client[0].find(".StdUI_Layout:not('."+t+"')",function(n){var i=n.addClass(t).ui();i&&"layoutItem"===i.ui&&e.createLayoutHandle(i)}),e},clearItemHandles:function(e){var t=this,n=e._handles;return n&&(Std.each(n,function(e,t){t.remove()}),delete e._handles),t},clearEventBlock:function(){var e=this,t=e._eventBlock;t&&e._hasEventBlock&&(Std.each(e._blockedEvents,function(e,n){Std.dom.removeEventBlock(n,t)}),e._hasEventBlock=!1)}},"public":{update:function(){return this._client.update(),this},receiving:function(e){var t=this,n=t.DOMMap;return void 0===e?t._receiving:(e===!0?(n.locker.detach(),t.editable()&&t.enable()&&t.createEventBlock()):(n.locker.appendTo(t[0]),t.clearEventBlock()),t._receiving=e,t)},currentItem:function(){return this._currentItem||this.selectedItem()},items:function(e,t){return this._client.layoutItems(e,t)},itemCount:function(){return this._client.itemCount()},editable:function(e){var t=this;return t.opt("editable",e,function(){e||(t.clearSelected(),t.clearEventBlock()),t._client.toggleClass("_preview",!e)})},dots:function(e){return this.opt("dots",e,function(){this._client[0].toggleClass("_dots")})},itemContextMenu:function(e){return this.opt("itemContextMenu",e,function(){this.initItemContextMenu(e)})},background:function(e){var t=this;return t.opt("background",e,function(){t[0].css("background",e)})},selectedItem:function(){return this._selectedItems[0]||null},selectedItems:function(){return Array.from(this._selectedItems)},layoutType:function(e){return this.opt("layoutType",e,function(){this._client.toggleLayout(e)})},insert:function(e,t,n){var i=this;return i._client.insert(e,t,n)===!1?!1:(i._client.update(),i.updateHelpers())},append:function(e){var t=this,n=t._client;return isArray(e)?Std.each(e,function(e,t){n.append(t)}):n.append(e),n.update(),t.updateHelpers()},put:function(e,t,n,i,o){{var l=this,a=t.insert(e,n);a.type()}return"GridLayout"===t.ui,"AbsLayout"===t.ui&&(a.left(i),a.top(o)),t.update(),l.updateHelpers()},replace:function(){},select:function(e){var t=this,n=null,i=t._selectedItems;return n=isObject(e)?e:t._client.layoutItems(e),!n||n._selected?t:(n._selected=!0,n._handles=t.createItemHandles(n),n.addClass("StdUI_View_SelectedItem"),i.push(n),Std.dom(t._currentItem=n).css("zIndex",++this._itemZIndex),t.emit("itemSelected",[n,!0],!0))},selectRange:function(e,t,n,i){var o=this,l=function(e,t,n,i){return e>=n&&i>=e||t>=n&&i>=t||n>=e&&t>=i};o._client.layoutItems(function(a,c){var u=c.left(),r=c.top(),s=c.width(),d=c.height();l(t,t+i,r,r+d)&&l(e,e+n,u,u+s)&&o.select(c)})},clearSelected:function(e){var t=this,n=t._selectedItems;if(void 0===e){for(var i=n.length-1;i>=0;i--)t.clearSelected(n[i]);t.emit("clearSelected")}else t._currentItem===e&&(t._currentItem=null),t.clearItemHandles(e),e._selected=!1,e.removeClass("StdUI_View_SelectedItem"),n.remove(n.indexOf(e));return t},html:function(){},config:function(){},value:function(){var e=this,t=e.opts;"config"===t.valueType}},main:function(e,t){e._items=Std.items(),e._selectedItems=[],e._eventBlock=function(){return e._client[0].contains(this)&&this.not(e._client)&&(this.not(".StdUI_View_ResizeHandle")||this.not(".StdUI_LayoutItem"))?!1:void 0},e.initDOMTree(),t.dots&&e.dots(!0),t.background&&e.background(t.background),t.items&&e.append(t.items)},m:{rule:{content:"html",children:function(){}},html:{nodeName:["DIV"],create:function(){}}}});