Std.ui.module("ImageCutterView",{parent:"widget",events:"dragStart dragStop dblclick",option:{level:4,pickerWidth:150,pickerHeight:150,image:null,scale:1,lockerOpacity:.4},"protected":{positionX:0,positionY:0,imageData:null},extend:{render:function(){var t=this;t.initPicker(),t.initDrag()}},"private":{initPicker:function(){var t=this,i=t.opts;return Std.dom(t.D.picker).css({width:i.pickerWidth,height:i.pickerHeight}),t},initDrag:function(){var t=this,i=t.opts,e=0,a=0,o=null,c=null,n=function(n){var r=t.D.picker.getContext("2d"),s=n.pageX-c.x-e+o.left,l=n.pageY-c.y-a+o.top;0>s?s=0:s>o.width-i.pickerWidth-2&&(s=o.width-i.pickerWidth-2),0>l?l=0:l>o.height-i.pickerHeight-2&&(l=o.height-i.pickerHeight-2),Std.dom(t.D.picker).css({top:l,left:s}),r.clearRect(0,0,i.pickerWidth,i.pickerHeight),r.drawImage(t._imageData,-++s,-++l,t._imageData.width*t.scale(),t._imageData.height*t.scale()),t._positionX=s+1,t._positionY=l+1};return Std.dom(t.D.picker).mouse({dblclick:function(){t.emit("dblclick")},up:function(i){t.emit("dragStop",i),t[0].off("mousemove",n),t[0].removeStyle("cursor")},down:function(i){var r=Std.dom(t.D.picker).position();t._imageData&&(c=t[0].offset(),o=Std.dom(t.D.image).css(["width","height"]),e=i.pageX-c.x-r.x,a=i.pageY-c.y-r.y,o.top=t[0].scrollTop(),o.left=t[0].scrollLeft(),t.emit("dragStart",i),t[0].on("mousemove",n),t[0].css("cursor","move"))}}),t}},"public":{lockerOpacity:function(t){return this.opt("lockerOpacity",t,function(){this.D.locker.opacity(t)})},imageSize:function(){var t=this,i=t._imageData;return null===i?i:{width:i.width,height:i.height}},attribute:function(){var t=this,i=t.opts;return{width:i.pickerWidth,height:i.pickerHeight,positionX:t._positionX,positionY:t._positionY}},scale:function(t){var i=this,e=i.opts;return this.opt("scale",t,function(){var t=i._imageData,a=i.D.image,o=i.D.picker,c=i.D.locker;a&&t&&(a.width=t.width*i.scale(),a.height=t.height*i.scale(),a.getContext("2d").drawImage(t,0,0,t.width*i.scale(),t.height*i.scale()),o.width=e.pickerWidth,o.height=e.pickerHeight,o.getContext("2d").drawImage(t,-1,-1,t.width*i.scale(),t.height*i.scale()),c.css({width:t.width*i.scale(),height:t.height*i.scale()}),Std.dom(o).css({left:0,top:0}))})},toBase64:function(){var t=this,i=t.opts,e=t._imageData,a=document.createElement("canvas"),o=a.getContext("2d");return null===e?e:(a.width=i.pickerWidth,a.height=i.pickerHeight,o.drawImage(e,-t._positionX,-t._positionY,e.width*t.scale(),e.height*t.scale()),a.toDataURL())},image:function(t){var i=this,e=function(t){i._imageData=t,i.scale(i.opts.scale)};return isObject(t)?e(t):"data:"===t.substr(0,5)?Std.loader.image(t,function(t,i){e(i)}):Std.loader(t,function(t){(t=t.data)&&e(t)}),i}},main:function(t,i,e){t.D={image:newDom("canvas","_image").dom,locker:newDiv("_locker").css({position:"absolute",left:0,top:0,width:"100%",height:"100%",background:"black"}),picker:newDom("canvas","_picker").css({position:"absolute",left:0,top:0,border:"1px dashed rgba(196,17,17,0.5)"}).dom},e.css({position:"relative",overflow:"auto",background:"white"}).append([t.D.image,t.D.locker,t.D.picker]),t.call_opts("image",!0),t.lockerOpacity(i.lockerOpacity)}}),Std.ui.module("ImageCutter",{parent:"widget",events:"submit",option:{level:4,pickerWidth:150,pickerHeight:150,boxSizing:"border-box",image:null,scale:1,lockerOpacity:.4},"private":{initEvents:function(){var t=this,i=t.widgets.view;return t.widgets.slider.on("change",function(t){i.scale(t/100)}),t.widgets.OK.on("click",function(){t.emit("submit",[i.toBase64(),i.attribute()],!0)}),t},initSelect:function(){var t=this,i=new Std.dom("input[type='file']",t.widgets.select).css({left:0,top:0,opacity:0,position:"absolute",width:"100%",height:"100%"});return i.on("change",function(){var e=i.dom.files;if(!(e.length<0)&&Std.url.suffix.img(Std.url(e[0].name).suffix)){var a=new FileReader;a.readAsDataURL(e[0]),a.onload=function(){t._fileSize=e[0].size,t._fileName=e[0].name,t.widgets.view.image(a.result)}}}),t},initWidgets:function(){var t=this,i=t.opts;return t.widgets=Std.ui({view:{ui:"ImageCutterView",scale:i.scale,image:i.image,pickerWidth:i.pickerWidth,pickerHeight:i.pickerHeight,lockerOpacity:i.lockerOpacity},slider:{ui:"HSlider",min:10,max:200,value:100},select:{ui:"Button",text:"select"},OK:{ui:"Button",text:"OK"}}),t}},"public":{image:function(t){var i=this;return i.widgets.view.image(t),i},fileName:function(){return this._fileName},fileSize:function(){return this._fileSize}},main:function(t){t.initWidgets(),t.initEvents(),t.initSelect(),t.layout({ui:"VBoxLayout",items:[t.widgets.view,{ui:"HBoxLayout",items:[t.widgets.slider,t.widgets.select,t.widgets.OK]}]})}});