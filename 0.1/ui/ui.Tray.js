Std.ui.module("TrayItem",{parent:"widget",option:{tabIndex:null,defaultClass:"StdUI_TrayItem",icon:"",name:"",text:"",popup:null,contextMenu:null},extend:{remove:function(){var t=this,e=t.opts;isWidget(e.contextMenu)&&e.contextMenu.remove()}},"public":{name:function(t){return this.opt("title",t,function(){this._tooltipTitle&&this._tooltipTitle.html(t)})},text:function(t){return this.opt("text",t,function(){this._tooltipText&&this._tooltipText.html(t)})},icon:function(t){var e=this;return e.opt("icon",t,function(){e[1].attr("src",t),e._tooltipIcon&&e._tooltipIcon.attr("img",t)})},popup:function(t){var e=this,i=e.opts;return void 0===t?i.popup:(i.popup=!isWidget(t)&&isObject(t)?Std.ui(t.ui||"widget",t):t,e)},contextMenu:function(t){var e=this,i=e.opts;return void 0===t?i.contextMenu:(!isWidget(t)&&isObject(t)&&(t=Std.ui(t.ui||"Menu",t)),isWidget(t)&&t.on("itemPress",function(){t.hide()}),i.contextMenu=t,e)}},main:function(t){t[0].append(t[1]=newDom("img")),t.call_opts({icon:"",name:"",text:"",popup:null,contextMenu:null},!0)}}),Std.ui.module("Tray",{parent:"widget",events:"itemClick",option:{level:3,height:35,spacing:4,iconSize:22,defaultClass:"StdUI_Tray",value:null,tabIndex:null},"private":{timer:null,state:!1,iconViewInitialized:!1,iconViewVisibled:!1,contextMenu:null},extend:{beforeRender:function(){},height:function(){this.updateHeight()},render:function(){var t=this;t.update(),t.initEvents(),t.initDocEvents()},remove:function(t){var e=this,i=e._items;if(void 0===t)e._popup&&e._popup.remove(),e._tooltip&&e._tooltip.remove(),e._docEvent&&Std.dom(document).off("mousedown",e._docEvent),e[3]&&e[3].remove(),Std.each(i,function(t,e){e.remove()});else if(isNumber(t))t<i.length&&(i[t].remove(),i.remove(t),e.update());else if(isWidget(t)){var o=i.indexOf(t);-1!==o&&(i[o].remove(),i.remove(o),e.update())}}},"protected":{initDocEvents:function(){var t=this;Std.dom(document).on("mousedown",t._docEvent=function(e){var i=e.target;if(!(t._contextMenu&&t._contextMenu[0].contains(e.target)||(t.hideContextMenu(),t[0].contains(i)||t[3]&&t[3].contains(i)))){if(t._popup){if(t._popup.contains(i))return;t.hidePopup()}if(t._tooltip){if(t._tooltip.contains(i))return;t.hideToolTip()}}})},createPopup:function(){var t=this;return t._popup&&t._popup.remove(),t._popup=newDiv("Tray_Popup").append([t._popupTitle=newDiv("_title"),t._popupMain=newDiv("_main")]).appendTo("body"),t},createToolTip:function(){var t=this,e=t.opts,i=1.5*e.iconSize;return t._tooltip&&t._tooltip.remove(),t._tooltip=newDiv("Tray_ToolTip").append([t._tooltipIcon=newDom("img","_icon").height(i).width(i),newDiv("_main").append([t._tooltipTitle=newDiv("_title"),t._tooltipText=newDiv("_text")])]).appendTo("body"),t},trayItemEvents:function(t,e){var i=this;clearTimeout(i._timer),i._state===!1?(i._state=!0,i._timer=setTimeout(function(){i.showToolTip(t)},800)):i.showToolTip(t),t[0].mouse({auto:!1,leave:function(){clearTimeout(i._timer),i._timer=setTimeout(function(){i.hideToolTip()},100)},down:function(){i._state=!1,clearTimeout(i._timer)},click:function(e){t.opts.popup?i.showPopup(t):i._popup&&i._popup.visible()&&i.hidePopup(),i.emit("itemClick",[e,t],!0)}},e)},initEvents:function(){var t=this;return t[0].on("mouseleave",function(){t._state=!1}).on("contextmenu",function(t){t.preventDefault()}).on("mouseenter",">.StdUI_TrayItem",function(e){return t.trayItemEvents(this.ui(),e)}).on("contextmenu",".StdUI_TrayItem",function(e){t.showContextMenu(this.ui(),e)}),t[2].on("click",function(){t._iconViewVisibled?t.hideIconView():t.showIconView()}),t},initIconView:function(){var t=this;return t._iconViewInitialized||(t[3]=newDiv("StdUI_Tray-iconView").appendTo("body"),t._iconViewInitialized=!0),t[3].on("mouseleave",function(){t._state=!1}).on("contextmenu",function(t){t.preventDefault()}).on("mouseenter",">.StdUI_TrayItem",function(e){return t.trayItemEvents(this.ui(),e)}).on("contextmenu",".StdUI_TrayItem",function(e){t.showContextMenu(this.ui(),e)}),t},updateHeight:function(){var t=this,e=t.height()-t.boxSize.height;return t[2].marginTop((e-t[2].height())/2),t},update:function(){var t=this,e=t.opts,i=t.width()-t.boxSize.width,o=t.height()-t.boxSize.height,n=t.iconSize(),p=Math.floor(o/(n+4)),u=Math.floor(i/(n+4)),d=0;return t._items.length<=u*p?(t[2].hide(),t[1].removeStyle("width")):(t[2].show(),u=Math.floor((i-=t[2].width())/(n+4)),t[1].width(i)),Std.each(t._items,function(i,o){return i>=u*p?(t._iconViewInitialized||t.initIconView(),void o[0].css("marginRight",e.spacing).appendTo(t[3])):(i+1%u===0&&d++,d>0&&p>d&&o[0].css("marginBottom",e.spacing),o[0].show().css("marginRight",e.spacing),o.appendTo(t[1]),void(o.renderState||o.render()))}),t[1].css("marginTop",(o-t[1].height())/2),t.updateIconViewHeight()},updateIconViewHeight:function(){var t=this;if(t[3]&&t[3].visible()){var e=t[0].offset(),i=t[3].removeStyle("height").outerHeight();0==t[3].height()?t.hideIconView():t[3].animate("end").animate({to:{top:e.y-i,outerHeight:i}},100)}}},"public":{showPopup:function(t){var e=this,i=e[0].offset(),o=t.popup();e._popup||e.createPopup(),isWidget(o)?(e._popupMain.clear(),e._popupMain.append(o),o.renderState||o.render()):(isString(o)||isNumber(o))&&e._popupMain.html(o),e._popupTitle.html(t.name()),e._popup.show();var n=i.x+(e.width()-e._popup.outerWidth())/2,p=i.y-e._popup.offsetHeight()-5;return 0>n?n=0:n+e._popup.offsetWidth()>Std.dom(window).width()&&(n=Std.dom(window).width()-e._popup.offsetWidth()),e._popup.css({top:p,left:n,zIndex:++Std.ui.status.zIndex}),e.hideToolTip().hideIconView()},hidePopup:function(){var t=this;return t._popup&&t._popup.hide(),t},updateToolTip:function(t,e,i){var o=this;return o._tooltipIcon.attr("src",t),o._tooltipTitle.html(e),o._tooltipText.html(i),o},showToolTip:function(t){var e=this,i=t[0].offset(),o=t.icon(),n=t.name(),p=t.text();e._tooltip?(e.updateToolTip(o,n,p),e._tooltip.show()):(e.createToolTip(),e.updateToolTip(o,n,p),e._tooltip.css({top:i.y-e._tooltip.offsetHeight()-5,left:0,visibility:"hidden"}));var u=i.x-(e._tooltip.offsetWidth()-t.width())/2,d=i.y-e._tooltip.offsetHeight()-5;return 0>u?u=0:u+e._tooltip.offsetWidth()>Std.dom(window).width()&&(u=Std.dom(window).width()-e._tooltip.offsetWidth()),0>d&&(d=i.y+e.height()),"hidden"===e._tooltip.css("visibility")&&e._tooltip.removeStyle("visibility").css("left",u),e._tooltip.css("zIndex",++Std.ui.status.zIndex).animate("end").animate({to:{top:d,left:u}},100),e},hideToolTip:function(){var t=this;return t._tooltip&&t._tooltip.hide(),t},showIconView:function(){var t=this,e=t[0].offset();t._iconViewInitialized||t.initIconView(),Std.each(t._items,function(t,e){!e.renderState&&e.render()}),t[3].removeStyle("height").show().css({outerWidth:t.width(),top:e.y-t[3].boxSize().height,left:e.x});var i=t[3].outerHeight();return t[2].addClass("_visibled"),t[3].height(0).animate("end").animate({to:{top:e.y-i,outerHeight:i}},100),t._iconViewVisibled=!0,t.hidePopup()},hideIconView:function(){var t=this;return t[2]&&t[3]&&(t[2].removeClass("_visibled"),t[3].animate("end").animate({to:{top:t[0].offset().y-t[3].boxSize().height,height:0}},100,function(){t[3].hide()}),t._iconViewVisibled=!1),t},showContextMenu:function(t,e){var i=this,o=t.contextMenu();if(o){o.renderState||(o[0].css("position","absolute"),o.renderTo("body")),o.show();var n=e.pageX,p=e.pageY-o.height();n+o.width()>Std.dom(window).width()&&(n=Std.dom(window).width()-o.width()),0>p&&(p=e.pageY),i._contextMenu=o.move(n,p),i.hideToolTip()}},hideContextMenu:function(){var t=this;return t._contextMenu&&t._contextMenu.hide(),t},iconSize:function(t){var e=this;return e.opt("iconSize",t,function(){Std.each(e._items,function(i,o){e[2].height(t).width(t),o.width(t).height(t)}),e.updateHeight()})},add:function(t){var e=this,i=Std.ui("TrayItem",t),o=e.iconSize();return i.parent(e).width(o).height(o),e._items.push(i),e.renderState&&i.render(),i},append:Std.func(function(t){{var e=this;e.add(t)}e.renderState&&e.update()},{each:[isArray]})},main:function(t,e,i){t._items=[],i.append([t[2]=newDiv("_handle").css({width:e.iconSize,height:e.iconSize}),t[1]=newDiv("_icons")]),e.items&&t.append(e.items)}});