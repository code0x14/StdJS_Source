Std.ui.module("MenuItem",{parent:"Item",action:{content:"text",children:"append"},option:{defaultClass:"StdUI_MenuItem",text:"menu item",items:null,root:null},"private":{childVisible:!1},extend:{render:function(){var e=this,t=e.opts;null!==t.items&&(e.D.open=newDiv("_open").appendTo(e[0]))},remove:function(e){var t=this;t.menu&&t.menu.remove(e),t.items&&t.items.clear()}},"public":{root:function(e){var t=this,i=t.opts;return void 0===e?i.root||t:(i.root=e,t)},insert:function(e,t){var i=this,n=i.D;return i.menu?i.menu.insert(e,t):(i.items||(i.items=[]),i.items.insert(e,t)),n.open||(n.open=newDiv("_open").appendTo(i[0])),i},append:Std.func(function(e){return this.insert(e)},{each:[isArray]}),showChild:function(){var e=this,t=e[0].offset();return e._childVisible?e:(e.menu||(e.menu=Std.ui("Menu",{parent:e,items:e.items,root:e.root(),renderTo:"body"})),e.menu.visible(e._childVisible=!0).toForeground(),e.menu[0].css({position:"absolute",left:t.x+e.width(),top:t.y,margin:0}),e)},hideChild:function(e){var t=this;return t.menu?(e===!1?t.menu.visible(t._childVisible=!1):t.menu[0].animate("end").animate({to:{opacity:0}},100,function(){t.menu.visible(t._childVisible=!1)}),t):t},childVisible:function(e){var t=this;return void 0===e?t._childVisible:e===t._childVisible?t:(t._childVisible===!0?t.showChild():t.hideChild(),t)}},main:function(e,t,i){var n=e.D;t.items&&(e.items=t.items),n.icon||e.initIcon(),n.text||i.append(n.text=newDiv("_text"))}}),Std.ui.module("Menu",{parent:"widget",events:"itemPress",option:{defaultClass:"StdUI_Menu",level:1,width:"auto",height:"auto",items:null,root:null},"private":{currentItem:null},extend:{render:function(){var e=this;e.items.each(function(e,t){t.render()})},visible:function(e){var t=this;e===!0?t[0].css("zIndex",++Std.ui.status.zIndex):(t.select(!1),t.items.each(function(e,t){t._childVisible&&t.hideChild()}))},remove:function(e){var t=this,i=t.items;if(void 0===e)i.each(function(e,t){t.remove()});else if(isNumber(e))i[e]&&i[e].remove()&&i.remove(e);else if(isWidget(e)){var n=i.indexOf(e);-1!==n&&i[n]&&i[n].remove()&&i.remove(n)}}},"protected":{keyEvent:function(e,t,i){var n=this,r=0,s=n.items,o=n.parent(),u=function(e){return!e.enable()||"MenuItem"!==e.ui};if(13===e)n.root().emit("itemPress",t.emit("press"));else if(27===e)isWidget(o)&&(n.hide(),"MenuItem"===o.ui?o.parent().focus():o.focus());else{if(37===e)return t.hideChild(),o&&"MenuItem"===o.ui&&(o.focus().hideChild(),o.parent().focus()),!1;if(38===e)return function(e){++r>s.length||(e=--e<0?s.length-1:e,u(s[e])?arguments.callee(e):n.select(e))}(i),!1;if(39===e)return t.menu&&(t.showChild(),t.menu.focus().select(0)),!1;if(40===e)return function(e){++r>s.length||(e=++e>=s.length?0:e,u(s[e])?arguments.callee(e):n.select(e))}(i),!1}},initKeyboard:function(){var e=this;return e[0].on({contextmenu:Std.func(!1),keydown:function(t){var i=e._currentItem,n=e.items.indexOf(i);return-1!=n?e.keyEvent(t.keyCode,i,n):void 0}}),e},initEvents:function(){var e=this,t=!1;return e[0].delegate("mouseenter mouseleave mousedown click",".StdUI_MenuItem",function(i){var n=e.items[this.index()],r=i.name;t===!1&&e[0].unselect(t=!0),n.enable()&&"sep"!==n.ui&&("click"===r?e.root().emit("itemPress",n.emit("press")):"mousedown"===r?i.stopPropagation():"mouseenter"==r?e.select(n):"mouseleave"!=r||n.childVisible()||e.select(!1))}),e},createItem:function(e){var t=null,i=this.root();return isString(e)?t=Std.ui("MenuItem",{text:e,root:i}):isWidget(e)?t=e:isObject(e)&&(e.root=i,t=Std.ui(e.ui||"MenuItem",e)),t}},"public":{each:function(e){return Std.each(this.items,e)},root:function(e){var t=this,i=t.opts;return void 0===e?i.root||t:(i.root=e,t)},select:function(e){var t=this;return e===t._currentItem?t:(t._currentItem&&(t._currentItem.removeClass("selected").hideChild(!1),t._currentItem=null),e===!1?t:(isNumber(e)&&(e=t.items[e]),isWidget(e)&&"MenuItem"===e.ui&&e.enable()?((t._currentItem=e.addClass("selected")).D.open&&e.showChild(),t):t))},insert:function(e,t){var i=this,n=i.createItem(e);return isWidget(n)&&(i[0].insert(n[0],t),i.renderState&&n.render(),i.items.insert(n.parent(i),t)),i},append:Std.func(function(e){this.insert(e)},{each:[isArray]})},main:function(e,t){e.items=[],null!=t.items&&e.append(t.items),e.initEvents(),e.initKeyboard()}});