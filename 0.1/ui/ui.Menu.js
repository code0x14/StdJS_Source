Std.ui.module("MenuItem",{parent:"Item",action:{content:"text",children:"append"},option:{defaultClass:"StdUI_MenuItem",text:"menu item",items:null,root:null},"private":{childVisible:!1},extend:{render:function(){var e=this,t=e.opts;null!==t.items&&(e.D.open=newDiv("_open").appendTo(e[0]))},remove:function(e){var t=this;t.menu&&t.menu.remove(e),t.items&&t.items.clear()}},"public":{root:function(e){var t=this,i=t.opts;return void 0===e?i.root||t:(i.root=e,t)},append:function(e){var t=this,i=t.D;return t.menu?t.menu.append(e):(t.items||(t.items=[]),t.items.push(e)),i.open||(i.open=newDiv("_open").appendTo(t[0])),t},showChild:function(){var e=this,t=e[0].offset();return e._childVisible?e:(e.menu||(e.menu=Std.ui("Menu",{parent:e,items:e.items,root:e.root(),renderTo:"body"})),e.menu.visible(e._childVisible=!0).toForeground(),e.menu[0].css({position:"absolute",left:t.x+e.width(),top:t.y,margin:0}),e)},hideChild:function(e){var t=this;return t.menu?(e===!1?t.menu.visible(t._childVisible=!1):t.menu[0].animate("end").animate({to:{opacity:0}},100,function(){t.menu.visible(t._childVisible=!1)}),t):t},childVisible:function(e){var t=this;return void 0===e?t._childVisible:e===t._childVisible?t:(t._childVisible===!0?t.showChild():t.hideChild(),t)}},main:function(e,t,i){var n=e.D;t.items&&(e.items=t.items),n.icon||e.initIcon(),n.text||i.append(n.text=newDiv("_text"))}}),Std.ui.module("Menu",{parent:"widget",events:"itemPress",option:{className:"StdUI_Menu",level:1,width:"auto",height:"auto",items:null,root:null},"private":{currentItem:null},extend:{render:function(){var e=this;e.items.each(function(e,t){t.render()})},visible:function(e){var t=this;e===!0?t[0].css("zIndex",++Std.ui.status.zIndex):(t.select(!1),t.items.each(function(e,t){t._childVisible&&t.hideChild()}))},remove:function(e){var t=this,i=t.items;if(void 0===e)i.each(function(e,t){t.remove()});else if(isNumber(e))i[e]&&i[e].remove()&&i.remove(e);else if(isWidget(e)){var n=i.indexOf(e);-1!==n&&i[n]&&i[n].remove()&&i.remove(n)}}},"protected":{keyEvent:function(e,t,i){var n=this,o=0,s=n.items,r=n.parent(),u=function(e){return!e.enable()||"MenuItem"!==e.ui};if(13===e)n.root().emit("itemPress",t.emit("press"));else if(27===e)isWidget(r)&&(n.hide(),"MenuItem"===r.ui?r.parent().focus():r.focus());else{if(37===e)return t.hideChild(),r&&"MenuItem"===r.ui&&(r.focus().hideChild(),r.parent().focus()),!1;if(38===e)return function(e){++o>s.length||(e=--e<0?s.length-1:e,u(s[e])?arguments.callee(e):n.select(e))}(i),!1;if(39===e)return t.menu&&(t.showChild(),t.menu.focus().select(0)),!1;if(40===e)return function(e){++o>s.length||(e=++e>=s.length?0:e,u(s[e])?arguments.callee(e):n.select(e))}(i),!1}},initKeyboard:function(){var e=this;return e[0].on({contextmenu:Std.func(!1),keydown:function(t){var i=e._currentItem,n=e.items.indexOf(i);return-1!=n?e.keyEvent(t.keyCode,i,n):void 0}}),e},initEvents:function(){var e=this,t=!1;return e[0].delegate("mouseenter mouseleave mousedown click",".StdUI_MenuItem",function(i){var n=e.items[this.index()],o=i.name;t===!1&&e[0].unselect(t=!0),n.enable()&&"sep"!==n.ui&&("click"===o?e.root().emit("itemPress",n.emit("press")):"mousedown"===o?i.stopPropagation():"mouseenter"==o?e.select(n):"mouseleave"!=o||n.childVisible()||e.select(!1))}),e}},"public":{each:function(e){return Std.each(this.items,e)},root:function(e){var t=this,i=t.opts;return void 0===e?i.root||t:(i.root=e,t)},select:function(e){var t=this;return e===t._currentItem?t:(t._currentItem&&(t._currentItem.removeClass("selected").hideChild(!1),t._currentItem=null),e===!1?t:(isNumber(e)&&(e=t.items[e]),isWidget(e)&&"MenuItem"===e.ui&&e.enable()?((t._currentItem=e.addClass("selected")).D.open&&e.showChild(),t):t))},append:Std.func(function(e){var t=this,i=null,n=t.root();isString(e)?i=Std.ui("MenuItem",{text:e,root:n}):isWidget(e)?i=e:isObject(e)&&(e.root=n,i=Std.ui(e.ui||"MenuItem",e)),isWidget(i)&&(t.renderState?i.renderTo(t[0]):i.appendTo(t[0]),t.items.push(i.parent(t)))},{each:[isArray]})},main:function(e,t){e.items=[],null!=t.items&&e.append(t.items),e.initEvents(),e.initKeyboard()}});