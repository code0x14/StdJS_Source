Std.ui.module("ComboBoxItem",{parent:"Item",option:{defaultClass:"StdUI_ComboBoxItem"}}),Std.ui.module("ComboBox",{parent:"widget",option:{level:3,defaultClass:"StdUI_ComboBox",boxSizing:"border-box",minWidth:40,minHeight:26,maxHeight:26,listMaxHeight:300,height:26,items:null,value:null,template:null,inputMode:"none",valueMode:"text",textField:"text",valueField:"value",dataSource:null,suggest:!1},events:"open close select change focus blur dataSourceLoad",action:{children:"append",childNodes:function(t,e){var n=[];Std.each(e,function(t,e){var i={},o=e.html(),s=e.attr("icon"),u=e.attr("std-option");isString(o)&&(i.text=o),isString(s)&&(i.icon=s),isString(u)&&Std.extend(i,u.toObject()),n.push(i)}),this.append(n)}},"private":{listVisible:!1,currentMode:"",currentItem:null,selectedItem:null},extend:{render:function(){var t=this;t.initEvents(),t.call_opts({value:null},!0)},remove:function(t){void 0===t&&(this.D.list&&this.D.list.remove(),this.delDocumentEvents())},height:function(t){var e=this,n=e.D;t=e.height()-e.boxSize.height,n.input&&n.input.css({height:t,lineHeight:t}),n.content&&n.content.css({height:t,lineHeight:t})},width:function(t){var e=this,n=e.D;t=e.width()-e.boxSize.width,n.input&&n.input.css({width:t-24}),n.content&&n.content.css({width:t-24})}},"protected":{createItem:function(t){var e=this,n=e.opts,i=null;return isString(t)?i=Std.ui("ComboBoxItem",{text:t}):isWidget(t)?i=t:isObject(t)&&(i=n.template?Std.ui("TemplateItem",{template:e.template(),data:t,textField:n.textField,valueField:n.valueField}):Std.ui(t.ui||"ComboBoxItem",t)),i},toggleList:function(){var t=this;if(t.enable())return 1==t._listVisible?t.close():t.open(),t},itemMouseEnter:function(t,e){var n=this,i=t.index(),o=n.items[i];return t.mouse({auto:!1,classStatus:!1,enter:function(){n._selectedItem&&n._selectedItem.removeClass("selected"),n._selectedItem=o.addClass("selected")},click:function(){n.value(o),n.toggleList(),n.focus()}},e),n},addDocumentEvents:function(){var t=this,e=t.D;return Std.dom(document).on("mousedown",t._documentEvents||(t._documentEvents=function(n){e.list&&e.list.contains(n.target)||t.delDocumentEvents().close()})),t},delDocumentEvents:function(){var t=this;return t._documentEvents&&Std.dom(document).off("mousedown",t._documentEvents),t},initHandle:function(){var t=this,e=t.D;return void 0!=e.handle?t:(e.handle=newDiv("_handle").appendTo(t[0]),t)},initKeyboard:function(){var t=this;return t.on("keydown",function(e){var n=t.items,i=n.indexOf(t._currentItem),o=e.which,s=e.keyCode;27===o?t.close():32===o&&"none"===t.inputMode()&&t.open(),-1!=i&&(38===s?(t.value(--i<0?n[n.length-1]:n[i]),t.focus()):40===s&&(t.value(++i>=n.length?n[0]:n[i]),t.focus()),"INPUT"===e.target.nodeName&&t.opts.suggest)}),t},initEvents:function(){var t=this,e=!1;return t[0].on({mousedown:function(e){1===e.which&&"INPUT"!==e.target.nodeName&&t.toggleList()},focusin:function(){t.addClass("focus").emit("focus"),e===!1&&(t.initKeyboard().on("focusout",function(){t.emit("blur")[0].removeClass("focus")}),t.D.input&&t.D.input.on("change",function(){t.emit("change")}),e=!0)}}).mouse({unselect:!0}),t},initList:function(){var t=this,e=t.D;return void 0!==e.list?t:(e.list=newDiv("StdUI StdUI_ComboBoxList").appendTo("body").on("mousedown",function(t){t.preventDefault()}).delegate("mouseenter",".StdUI_ComboBoxItem,.StdUI_TemplateItem",function(e){t.itemMouseEnter(this,e)}),t.items.each(function(t,n){n.renderTo(e.list)}),t)}},"public":{textField:function(t){return this.opt("textField",t)},valueField:function(t){return this.opt("valueField",t)},valueMode:function(t){return this.opt("valueMode",t)},dataSource:function(t){var e=this;return e.opt("dataSource",t,function(){e.reload()})},text:function(t){var e=this,n=e.D;return void 0===t?n.content.text():(n.content.text(t),e)},select:function(t){var e=this;return isNumber(t)&&(t=e.items[t]),isWidget(t)&&e._currentItem!==t&&(e._currentItem&&e._currentItem.removeClass("selected"),e._currentItem=e._selectedItem=t.addClass("selected"),e.emit("select change",t)),e},template:function(t){var e=this,n=e.opts;return void 0===t?n.template:(isString(t)&&(t=Std.template(t)),t instanceof Std.template&&(n.template=t),e)},value:function(t){var e=this,n=e[e.opts.valueMode+"Value"];return e.D.list||e.initList(),isFunction(n)?n.call(e,t):void 0===t?null:e},reload:function(){var t=this,e=t.dataSource(),n=e.read;"ajax"===e.type&&isObject(n)&&Std.ajax.json({url:n.url,data:n.data,type:n.type}).on("success",function(e){t.clear(),t.append(Std.mold.dataPath(e,n.dataPath)),t.call_opts("value",!0),t.emit("dataSourceLoad",e)})},inputMode:function(t){var e=this,n=e.D;return e.opt("inputMode",t,function(){n.input&&n.input.remove(),n.content&&n.content.remove(),""!==e._currentMode&&e.removeClass("_"+e._currentMode),"input"===t?n.input=newDom("input","_input").appendTo(e[0]):"none"===t&&(n.content=newDiv("_content").appendTo(e[0])),e.addClass("_"+(e._currentMode=t))})},textValue:function(t){var e=this,n=e.D,i=t,o=e.inputMode();if("input"===o){if(void 0===t)return n.input.value();isWidget(t)&&(i=t.text()),n.input&&n.input.value(i)}else if("none"===o){if(void 0===t)return e.text();isWidget(t)&&(i="TemplateItem"===t.ui?t.text():t[0].clone().className(t.opts.defaultClass)),n.content&&n.content.html(i)}return e.select(t)},indexValue:function(t){var e=this,n=e.D,i=null,o=e.items,s=t,u=e.inputMode();if(void 0===t)return e._currentItem?o.indexOf(e._currentItem):null;if(isWidget(t)){if(-1===(s=o.indexOf(t)))return e}else isString(s)&&(s=int(s));return(i=o[s])?("input"===u?n.input&&n.input.value(i.text()):"none"===u&&n.content&&n.content.html("TemplateItem"===i.ui?i.text():i[0].clone().className(i.opts.defaultClass)),e.select(s)):e},itemValue:function(t){var e=this,n=e.D,i=null,o=e.items,s=-1,u=e.inputMode();if(void 0===t)return e._currentItem?e._currentItem.value():null;if(isWidget(t)){if(-1===(s=o.indexOf(t)))return e;i=t}return-1==s&&e.items.each(function(e,n){return n.value()==t?(i=n,s=e,!1):void 0}),null===i?e.select(s):("input"===u?n.input&&n.input.value(i.text()):"none"===u&&n.content&&n.content.html("TemplateItem"===i.ui?i.text():i[0].clone().className(i.opts.defaultClass)),e.select(s))},open:function(){var t=this,e=t.D,n=t[0].offset(),i=0;if(t._listVisible)return t;e.list||t.initList(),e.list.show(),e.handle.addClass("_open"),(i=e.list.offsetHeight())>t.opts.listMaxHeight&&(i=t.opts.listMaxHeight);var o=n.y+t.height(),s={height:i-e.list.boxSize().height,opacity:1};return n.y+t.height()+i>Std.dom(window).height()&&(e.list.addClass("_top"),s.top=(o=n.y)-i),e.list.css({left:n.x,top:o,width:t[0].width()-2,height:0,opacity:0,overflow:"hidden"}).animate("end").animate({100:s},{duration:150,timingFunction:"ease-in"},function(){t.addDocumentEvents(),e.list.removeStyle("overflow")}),setTimeout(function(){e.list.css("zIndex",++Std.ui.status.zIndex)},5),t._listVisible=!0,t.emit("open")},close:function(){var t=this,e=t.D,n=t[0].offset(),i={height:0,opacity:0};return t._listVisible?(n.y>e.list.css("top")&&(i.top=n.y),e.handle.removeClass("_open"),e.list&&e.list.css("overflow","hidden").animate("end").animate({100:i},140,function(){e.list.hide().removeStyle("overflow height").removeClass("_top"),null!==t._selectedItem&&t._selectedItem.removeClass("selected"),null!==t._currentItem&&(t._selectedItem=t._currentItem.addClass("selected"))}),t.delDocumentEvents(),t._listVisible=!1,t.emit("close")):t},insert:function(t,e){var n=this,i=n.createItem(t);if(isWidget(i)){var o=n.items;n.D.list&&(n.D.list.insertBefore(i,o[e]),i.render()),o.insert(i.parent(n),e)}return n},append:Std.func(function(t){var e=this,n=e.createItem(t);isWidget(n)&&(e.D.list&&n.renderTo(e.D.list),e.items.push(n.parent(e)))},{each:[isArray]}),clear:function(){var t=this,e=t.items;return Std.each(e,function(t,e){e.remove()}),e.clear(),t}},main:function(t,e){t.D={},t.items=[],t.inputMode(e.inputMode),t.initHandle(),t.call_opts("dataSource",!0),null!==e.template&&t.template(e.template),null!==e.items&&t.append(e.items)}});