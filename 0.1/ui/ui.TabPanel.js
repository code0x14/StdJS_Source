Std.ui.module("TabButton",{parent:"Button",option:{height:30,level:4,closable:!1,styleType:"text",defaultClass:"StdUI_TabButton"},"private":{selected:!1},"protected":{initClosableElement:function(){var t=this,e=t.D;return e.tr1.append(e.closeTD=newDom("td","_close").append(e.closeButton=newDiv("_closeButton").mouse({down:function(t){t.stopPropagation()},click:function(){var e=t.parent();e&&e.remove()}}))),t}},"public":{closable:function(t){var e=this;return e.opt("closable",t,function(){t===!0?e.D.closeTD||e.initClosableElement():(e.D.closeButton.remove(),e.D.closeTD.remove())})},select:function(t){var e=this;return void 0===t?e._selected:(e.toggleClass("selected",e._selected=t),e)}},main:function(t,e){e.closable&&t.initClosableElement()}}),Std.ui.module("TabPanel",function(){var t=Std.module({option:{button:null,content:null,value:null},"public":{value:function(t){return this.opt("value",t)},index:function(){return this.parent.items.indexOf(this)},select:function(){this.parent.select(this.index())},remove:function(){this.parent.removeTab(this.index())}},main:function(t,e){var n=this,o=n.init_opts(t),i=null,a=null;if(isString(o.button))i=Std.ui("TabButton",{parent:n,text:o.button,height:e.opts.tabButtonHeight,closable:e.opts.tabClosable});else if(isObject(o.button)){var r=o.button;r.parent=n,r.height=e.opts.tabButtonHeight,"closable"in r||(r.closable=e.opts.tabClosable),i=Std.ui("TabButton",o.button)}isString(o.content)?a=Std.ui("widget",{tabIndex:null,defaultClass:"StdUI_TabContent",html:o.content}):isWidget(o.content)?a=Std.ui("widget",{tabIndex:null,defaultClass:"StdUI_TabContent",layout:{ui:"VBoxLayout",items:[o.content]}}):isLayout(o.content)?a=Std.ui("widget",{tabIndex:null,defaultClass:"StdUI_TabContent",layout:o.content}):isObject(o.content)&&(a=Std.ui(o.content.ui||"widget",Std.extend({tabIndex:null,defaultClass:"StdUI_TabContent"},o.content))),n.parent=e,n.button=i,n.content=a}});return{parent:"widget",option:{defaultClass:"StdUI_TabPanel",level:4,height:300,tabButtonHeight:32,tabButtonSpacing:2,tabClosable:!1,tabDroppable:!1,maxTabButtonWidth:"50%",contentPadding:5,deferRender:!0,activeIndex:0,items:null,tabAlign:"left",tabPosition:"top"},events:"removeTab selectTab","private":{activeIndex:null,tabBarOverflowed:!1,lastWidth:null,lastHeight:null,direction:null,timer1:null,dropDownMenu:null},extend:{render:function(){var t=this,e=t.opts;t.items.each(function(t,n){n.button.render(),e.deferRender||n.content.render()}),t.initEvents(),t.initKeyboard(),t.select(e.activeIndex),t.tabBarOverflowCheck()},width:function(){this.updateLayout()},height:function(){var t=this,e=t.D,n=t.computeContentHeight();t.items.each(function(t,e){e.content.height(n)}),e.contents.height(n)},remove:function(t){var e=this,n=e.items;return void 0===t?(e._dropDownMenu&&e._dropDownMenu.remove(),n.each(function(t,e){e.button.remove(),e.content.remove()}),void n.clear()):(isObject(t)&&(t=n.indexOf(t)),void(-1!==t&&n[t]&&e.removeTab(~~t)))}},"protected":{initKeyboard:function(){var t=this;return t},initData:function(){var t=this,e=t.opts;return t.items=[],null!==e.items&&t.append(e.items),t.call_opts({contentPadding:0},!0)},initElements:function(){var t=this,e=t.D={};return t[0].append([e.contents=newDiv("_contents")]),t},initEvents:function(){var t=this;return t.D.buttons.delegate("mousedown",".StdUI_TabButton",function(e){var n=this.index(),o=t.items[n].button;1===e.which&&(t.select(n),"vertical"===t._direction?t.verticalTabButtonClick(n,o):t.horizontalTabButtonClick(n,o))}),t},initTabBar:function(){var t=this,e=t.D;return t[0].append(e.tabBar=newDiv("_tabBar").height(t.opts.tabButtonHeight).append([e.leftTools=newDiv("_tools _left"),e.line=newDiv("_line"),e.tabs=newDiv("_tabs").append(e.buttons=newDiv("_buttons")),e.rightTools=newDiv("_tools _right")])),t},initClient:function(){var t=this,e=t.D;switch(e.contents=newDiv("_contents"),t.opts.tabPosition){case"right":case"bottom":t[0].prepend(e.contents);break;case"left":case"top":t[0].append(e.contents)}return t.addClass("_"+t.opts.tabPosition),e},initScrollButtons:function(t,e,n){var o=this,i=o.opts,a=o.D,r={down:t,delay:10,interval:3};return a.leftTools.append(a.prevBtn=newDiv("_scrollButton _backward").height(i.tabButtonHeight-1).mouse(Std.extend(r,{longpress:e})).append(newDiv("_icon"))),a.rightTools.append([a.nextButton=newDiv("_scrollButton _forward").height(i.tabButtonHeight-1).mouse(Std.extend(r,{longpress:n})).append(newDiv("_icon")),a.controlHand=newDiv("_controlHand").height(i.tabButtonHeight-1).mouse({down:function(t){1===t.which&&(o._dropDownMenu?o._dropDownMenu.remove():(this.addClass("selected"),o.initDropDownMenu()))}}).append(newDiv("_icon"))]),o._tabBarOverflowed=!0,o},initHScrollButtons:function(){if(this._tabBarOverflowed)return this;var t=this,e=t.opts,n=t.D,o=0,i=0,a=0,r=e.tabButtonSpacing,s=n.tabBar.width()-r;return t.initScrollButtons(function(){o=0,a=n.buttons.css("margin-top"),i=n.tabs.height(),Std.each(t.items,function(t,e){o+=e.button.height()+r})},function(){r>a&&n.buttons.css("margin-top",a+=3)},function(){o+a>i&&n.buttons.css("margin-top",a-=3)}),Std.dom.united([n.prevBtn,n.nextButton,n.controlHand]).css({height:25,width:s}),n.buttons.css("margin-top",r),t.updateTabsHeight()},initVScrollButtons:function(){if(this._tabBarOverflowed)return this;var t=this,e=t.opts,n=t.D,o=0,i=0,a=0,r=e.tabButtonHeight-1,s=e.tabButtonSpacing;return t.initScrollButtons(function(){o=0,a=n.buttons.css("margin-left"),i=n.tabs.width(),Std.each(t.items,function(t,e){o+=e.button.width()+s})},function(){s>a&&n.buttons.css("margin-left",a+=3)},function(){o+a>i&&n.buttons.css("margin-left",a-=3)}),n.prevBtn.height(r),n.nextButton.height(r),n.buttons.css("margin-left",s),t.updateTabsWidth()},initDropDownMenu:function(){var t=this,e=t.D,n=t.opts.tabButtonHeight;if(t._dropDownMenu)return t;var o=function(t){var n=t.target;i[0].contains(n)||e.controlHand.contains(n)||i.remove()},i=t._dropDownMenu=Std.ui("Menu",{renderTo:t,maxHeight:t.height()-n,css:{position:"absolute",boxShadow:"none"},items:[{text:"Close All",click:function(){for(var e=t.items.length-1;e>=0;e--){var n=t.items[e];n&&n.button.closable()&&t.remove(n)}t.tabBarOverflowCheck()}},{text:"First Page",click:function(){t.activeIndex(0).updateTabScroll()}},{text:"Last Page",click:function(){t.activeIndex(t.items.length-1).updateTabScroll()}},{ui:"sep"}],on:{itemPress:function(){i.remove()},visible:function(t){e.controlHand.toggleClass("selected",t)},remove:function(){e.controlHand.removeClass("selected"),t._dropDownMenu=null,Std.dom(document).off("mousedown",o)}}}).toForeground();switch(t.opts.tabPosition){case"top":i[0].css({right:0,top:n-1});break;case"right":i[0].css({right:0,bottom:e.controlHand.outerHeight()-1});break;case"bottom":i[0].css({right:0,bottom:n});break;case"left":i[0].css({left:0,bottom:e.controlHand.outerHeight()-1})}return Std.each(t.items,function(e,n){var o=n.button,a=o.text(),r=o.icon(),s=o.iconClass();i.append({text:a,icon:r,iconClass:s,checked:t._activeItem===n,click:function(){t.activeItem(n).updateTabScroll()}})}),Std.dom(document).on("mousedown",o),t},computeContentHeight:function(){var t=this,e=t.opts,n=t.D,o=t.height(),i=o-2*e.contentPadding-2;switch(e.tabPosition){case"left":case"right":n.tabBar.height(o-t.boxSize.height),t._tabBarOverflowed&&t.updateTabsHeight();break;case"top":n.line.css("top",e.tabButtonHeight-1);case"bottom":i-=e.tabButtonHeight}return i},verticalTabButtonClick:function(t,e){var n=this,o=e.width(),i=n.D.tabs.width(),a=e[0].position().x,r=n.opts.tabButtonSpacing;return a+o>i?n.D.buttons.animate("end").animate({to:{"margin-left[+]":i-(a+o)-r}},100):0>a&&n.D.buttons.animate("end").animate({to:{"margin-left[-]":a-r}},100),n},horizontalTabButtonClick:function(t,e){var n=this,o=e.height(),i=n.D.tabs.height(),a=e[0].position().y,r=n.opts.tabButtonSpacing;return a+o>i?n.D.buttons.animate("end").animate({to:{"margin-top[+]":i-(a+o)-r}},100):0>a&&n.D.buttons.animate("end").animate({to:{"margin-top[-]":a-r}},100),n},tabBarOverflowCheck:function(){var t=this,e=0,n=t.opts.tabButtonSpacing;switch(t._direction){case"horizontal":Std.each(t.items,function(t,o){e+=o.button.height()+n}),e>t.height()?t.initHScrollButtons():t._tabBarOverflowed&&t.removeScrollButtons();break;case"vertical":Std.each(t.items,function(t,o){e+=o.button.width()+n}),e>t.width()?t.initVScrollButtons():t._tabBarOverflowed&&t.removeScrollButtons()}return t},removeScrollButtons:function(){var t=this,e=t.D;return e.buttons.css({marginTop:0,marginLeft:0}),Std.dom.united([e.prevBtn,e.nextButton,e.controlHand]).remove(),t._dropDownMenu&&t._dropDownMenu.remove(),t._tabBarOverflowed=!1,t.updateTabsWidth()},updateTabsWidth:function(){var t=this,e=t.D;return e.tabs.width(t.width()-e.leftTools.width()-e.rightTools.width()),t},updateTabsHeight:function(){var t=this,e=t.D;return e.tabs.height(t.height()-e.leftTools.height()-e.rightTools.height()),t},updateTabScroll:function(){var t=this,e=t.activeIndex();return t["horizontal"===t._direction?"horizontalTabButtonClick":"verticalTabButtonClick"](e,t.items[e].button),t},updateHorizontalLayout:function(){var t=this,e=t.D,n=t.width(),o=e.tabBar.width();switch(t.opts.tabPosition){case"left":e.line.css("left",o-1);case"right":e.contents.width(n-2*t.opts.contentPadding-o-2)}return t.items.each(function(e,i){i.content.width(n-2*t.opts.contentPadding-o-2)}),t},updateVerticalLayout:function(){var t=this,e=t.opts,n=t.width()-2*e.contentPadding-t.boxSize.width-2;return t.tabBarOverflowCheck(),t._tabBarOverflowed&&t.updateTabsWidth(),t.items.each(function(t,e){e.content.width(n)}),t},updateLayout:function(){var t=this;return null!==t._timer1&&clearTimeout(t._timer1),t._timer1=setTimeout(function(){"horizontal"===t._direction?t.updateHorizontalLayout():t.updateVerticalLayout()},0),t},convertIndex:function(t,e){var n=this,o=-1,i=n.items;if("first"===t)o=0;else if("last"===t)o=i.length-1;else if("beside"===t){var a=i.length;a-1>e?o=e:a>1?o=e-1:1===a&&(o=0)}return o}},"public":{appendTab:function(t,e){return this.insertTab(t,-1,e)},contentPadding:function(t){var e=this;return e.D.contents.css("padding",t+"px"),e},select:function(t,e){var n=this;return isString(t)&&(t=n.convertIndex(t,e)),-1!==t&&t<n.items.length&&(n.activeIndex(t),n.emit("selectTab",[t,n.items[t]],!0)),n},activeIndex:function(t){var e=this,n=e.items;return void 0===t?n.indexOf(e._activeItem):(n[t]&&e.activeItem(n[t]),e)},activeItem:function(t){var e=this,n=e.items;if(void 0===t){var o=e.activeIndex();return-1==o?null:n[o]}var i=e._activeItem;return i&&(i.button.select(!1),i.content.removeClass("_visible")),t.button.select(!0),t.content.addClass("_visible"),e._activeItem=t,e.updateLayout(),t.content.renderState||(t.content.height(e.computeContentHeight()),t.content.render()),e},append:function(t){var e=this;return isArray(t)?Std.each(t,function(t,n){e.appendTab(n,!1)}):isObject(t)&&e.appendTab(t,!1),e.renderState&&(e.tabBarOverflowCheck(),e.updateLayout()),e},insertTab:function(e,n,o){var i=this,a=i.opts,r=i.D,s=new t(e,this);return-1===n?(r.buttons.append(s.button[0]),r.contents.append(s.content[0]),i.items.push(s)):(r.buttons.insert(s.button[0],n),r.contents.insert(s.content[0],n),i.items.insert(s,n)),i.renderState&&(s.button.render(),o!==!1&&(i.tabBarOverflowCheck(),i.updateLayout()),a.deferRender||(s.content.height(i.computeContentHeight()),s.content.render())),s},removeTab:function(t){var e=this,n=e.items,o=n[t],i=e.activeIndex();return n[t].button.remove(),n[t].content.remove(),e.items.remove(t),t===i&&e.select("beside",t),e.tabBarOverflowCheck().emit("removeTab",[t,o],!0)},clear:function(){var t=this;return t.items.each(function(t,e){e.button.remove(),e.content.remove()}),t.items.clear(),t._activeItem=null,t}},main:function(t,e){switch(e.tabPosition){case"left":case"right":t._direction="horizontal";break;case"top":case"bottom":t._direction="vertical"}t.D={},t.initTabBar(),t.initClient(),t.initData()}}});