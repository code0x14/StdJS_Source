Std.ui.module("Tree",function(){var e=Std.module({option:{id:null,tree:null,type:null,icon:null,text:"",value:null,iconClass:null,parent:null,selected:!1,checked:!1,checkable:!1},"private":{readJSON:function(e,t,n){return e.addClass("_loading"),isString(t)?Std.ajax.json(t,n).success(function(){e.removeClass("_loading")}):isObject(t)&&Std.ajax.json(Std.extend({success:n},t)).success(function(){e.removeClass("_loading")}),this},createCheckBox:function(){var e=this,t=e.D,n=t.checkbox=newDom("i","_checkbox").prependTo(t.anchor);return e.checked()&&n.addClass("checked"),e},createChildNode:function(t){var n=this,i=n.tree(),o=t.type,s=i.checkable();!s||"checkable"in t||(t.checkable=s),o&&o in i._types&&(t=i.makeNodeOption(o,t));var r=new e(i,t);return r.parent(n),r},createChildNodes:function(e){{var t=this;t.D.ul=newDom("ul","_container_ul").appendTo(t.D.li)}return t._items?t._items.clear():t._items=[],Std.each(e,function(e,n){var i=t._createChildNode(n);t._items[e]=i.insertTo(t.D.ul)}),t},createNodeIcon:function(){var e=this,t=e.opts,n=t.icon,i=t.iconClass;return(n||i)&&(i=isString(i)?"_icon "+i:"_icon",e.D.icon=newDom("i",i).appendTo(e.D.anchor),isString(n)&&e.D.icon.append(newDom("img").attr("src",n))),e},createNodeAnchor:function(){var e=this,t=e.opts,n=e.D.anchor=newDom("a","_anchor").appendTo(e.D.li.append(e.D.hand=newDom("i","_hand _empty"))).on("dragstart",Std.func(!1));return t.checkable&&e._createCheckBox(),e._createNodeIcon(),t.color&&n.color(t.color),t.href&&n.attr("href",t.href),t.target&&n.attr("target",t.target),t.text&&n.append(e.D.text=newDom("span").html(t.text)),e},updateCheckBox:function(e){var t=this,n=t.opts;if(t._items)for(var i=0,o=t._items.length;o>i;i++)t._items[i].checked(e);if(n.items)for(var i=0,o=n.items.length;o>i;i++)n.items[i].checked=e;return t}},"public":{id:function(e){return this.opt("id",e)},tree:function(e){return this.opt("tree",e)},value:function(e){return this.opt("value",e)},parent:function(e){return this.opt("parent",e)},checkable:function(e){return this.opt("checkable",e)},index:function(){return this.parent()._items.indexOf(this)},text:function(e){return this.opt("text",e,function(){this.D.text.text(e)})},expanded:function(e){return this.opt("expanded",e,function(){this.expand(e)})},expandAll:function(){var e=this.expanded(!0);return Std.each(e._items,function(e,t){t.expandAll()}),e},collapseAll:function(){var e=this.expanded(!1);return Std.each(e._items,function(e,t){t.collapseAll()}),e},count:function(){var e=this,t=e.opts;return e._items?e._items.length:t.items?t.items.length:0},path:function(t){var n=this,i=[];do n instanceof e&&i.push("name"===t?n.text():n.index());while(n=n.parent());return i.reverse().join("/")},update:function(){var e=this,t=e.opts,n="_hand";return isEmpty(t.items)&&isEmpty(e._items)?n+=" _empty":t.expanded&&(n+=" _expanded",e.D.ul||e._createChildNodes(t.items)),e.D.hand.className(n),e},selected:function(e,t){var n=this,i=n.tree();return n.opt("selected",e,function(){if(t!==!1){var o=i._selectedItems;e===!0?o.push(n):o.remove(o.indexOf(n))}n.D.anchor.toggleClass("selected",e)})},checked:function(e,t){var n=this;return n.opt("checked",e,function(){var i=n.tree(),o=i._checkedItems;n.D.checkbox.toggleClass("checked",e),t!==!1&&(e===!0?o.push(n):o.remove(o.indexOf(n))),"checkedItems"===i.selectionMode()&&n.selected(e),n._updateCheckBox(e),i.emit("itemChecked",e)})},insertTo:function(e,t){var n=this,i=n.opts,o=n.tree(),s=n.D.li=newDom("li","_container_li").data("node",n),r=o.selectionMode();return n._createNodeAnchor(),(i.selected||i.checked&&"checkedItems"===r)&&n.selected(!0),i.id&&i.tree&&i.tree.map(i.id,n),void 0===t||-1===t?e.append(s):isNumber(t)&&e.insert(s,t),n.update()},expand:Std.func(function(e){var t=this,n=t.opts,i=t.D;if(e===!0&&isEmpty(i.ul)&&n.items)if(isArray(n.items))t._createChildNodes(n.items),i.ul.hide();else if(isString(n.items)||isObject(n.items))return t._readJSON(i.hand,n.items,function(e){n.items=e,t.expand(!0)});if(!isEmpty(i.ul)){var o=function(e){return(e/=2.5)>300?e=300:100>e&&(e=100),e};if((n.expanded=e)===!0){var s=i.ul.show().offsetHeight(),r=i.ul.width();i.ul.css({width:r,height:0,opacity:.5,overflow:"hidden"}).animate("end").animate({50:{opacity:1},to:{opacity:1,height:s}},o(s),function(){i.ul.removeStyle("overflow width height opacity")})}else i.ul.css({width:i.ul.width(),overflow:"hidden",opacity:1}).animate("end").animate({to:{height:0,opacity:.5}},o(i.ul.offsetHeight()/2.5),function(){i.ul.removeStyle("overflow width height opacity").hide()});i.hand.toggleClass("_expanded",e)}}),add:function(e){var t=this,n=t.opts,i=t.D,o=t._createChildNode(e);return n.items||(n.items=[]),n.items.push(e),isEmpty(i.ul)||t._items.push(o.insertTo(i.ul)),o},append:function(e){var t=this;return isArray(e)?Std.each(e,function(e,n){t.add(n)}):t.add(e),t.update()},insertBefore:function(e,t){var n,i=this,o=i.opts.items;return o&&-1!==(n=o.indexOf(t))&&i.insert(e,n),i},insertAfter:function(e,t){var n,i=this,o=i.opts.items;return o&&-1!==(n=o.indexOf(t))&&i.insert(e,n+1),i},insert:function(e,t){var n=this,i=n.opts,o=n.D,s=n._createChildNode(e);return i.items||(i.items=[]),void 0===t?n.add(e).update():(isObject(t)&&(t=n._items.indexOf(t)),isNumber(t)&&(i.items.insert(e,t),isEmpty(o.ul)||n._items.insert(s.insertTo(o.ul,t),t)),n.update())},remove:function(e){var t=this,n=t.opts,i=t.tree();if(void 0===e){var o=n.parent._items,s=o.indexOf(t);-1!==s&&o.remove(s),n.id&&delete i._IDMap[n.id],t.D.li.remove(),t.update()}}},main:function(e,t){this.D={},this._items=[],this.init_opts(t),this.opts.tree=e}});return{parent:"widget",events:"clear selectionModeChange itemPositionChange dataSourceLoad itemClick itemDblClick itemRename itemChecked",option:{defaultClass:"StdUI_Tree",level:4,items:null,lines:!1,expanded:!1,checkable:!1,editable:!1,droppable:!1,itemHeight:20,dataSource:null,itemContextMenu:null,selectionMode:"items"},extend:{render:function(){var e=this,t=e.opts;t.checkable&&e.initCheckboxEvents(),t.droppable&&e.initDroppableEvents(),e.initEvents(),e.initKeyboardEvents(),e.updateStyle()},remove:function(t){var n=this,i=n.opts;void 0!==t&&(isNumber(t)&&(i.items&&i.items.length>t&&i.items.remove(t),t=n._items[t]),isString(t)&&(t=n.map(t)),t instanceof e&&t.remove())}},"protected":{createTreeItem:function(t){var n=this,i=t.type;i&&i in n._types&&(t=n.makeNodeOption(i,t));var o=new e(n,t);return o.parent(n),o.checkable(n.opts.checkable),o},makeNodeOption:function(e,t){var n=this,i=n._types[e];for(var o in i)o in t||(t[o]=i[o]);return t},anchorMouseEvents:function(e,t){var n=this,i=e.parent(),o=i.data("node"),s=n.selectionMode();e.mouse({auto:!1,click:function(e){n.emit("itemClick",[o,e],!0)},dblclick:function(e){n.editable()?n.editNode(o):o.expand(!o.expanded()),n.emit("itemDblClick",[o,e],!0)},down:function(e){"item"==s?(n.clearSelected(),o.selected(!0),e.stopPropagation()):"items"==s&&(e.ctrlKey||n.clearSelected(),o.selected(!o.selected()))}},t)},editNode:function(e){if(e._editState)return this;var t=this,n=e.text(),i=null,o=newDom("input","_input").value(n).on("mousedown",function(e){e.stopPropagation()}),s=newDom("span").css({top:-99,font:o.css("font"),fontSize:o.css("fontSize"),position:"absolute",visibility:"hidden"});return e._editState=!0,s.appendTo(t[0]),e.D.text.hide(),e.D.anchor.append(o.width(s.text(n).width()).focus().on({mousedown:function(e){e.stopPropagation()},blur:function(){var i=o.value();e.text(i),e.D.text.show().text(i),Std.dom.united([s,o]).remove(),n!==i&&t.emit("itemRename",[e,i,n],!0),e._editState=!1},keydown:function(e){13===e.keyCode?o.blur():(clearTimeout(i),i=setTimeout(function(){o.width(s.text(o.value()).width())},1))}})),o.select(),t},initKeyboardEvents:function(){var e=this;return e[0].on("keydown",function(t){if(113===t.keyCode&&e.editable()){var n=e._selectedItems;!isEmpty(n)}}),e},initDroppableEvents:function(){var e=this,t=0,n=!1,i=null,o=null,s=null,r=null,a=!1,c=null,d=null,u=null,l=function(t){a=!1,e[0].append(c=newDiv("_position").opacity(.5)),Std.dom("body").append(s=o.clone().className("StdUI_Tree_CloneAnchor").css({top:t.pageY+10,left:t.pageX+10,opacity:.8,position:"absolute",zIndex:Std.ui.status.zIndex+1,width:o.width()}))},h=function(){s.remove(),c.remove(),r=o=s=c=u=null},p=function(e){a!==e&&c.visible(a=e)},m=function(a){var h="",m=a.pageY-d.y,f=e[0].scrollTop();return n===!1?(a.preventDefault(),l(a,n=!0)):(m<=i.y+5?(h="before",p(!0),c.top(i.y+f)):m>=i.y+e.itemHeight()?(h="after",p(!0),c.top(i.y+f+e.itemHeight()+4)):r.is(o)||(h="in",p(!1),c.top(i.y+f)),h!==u&&s.className("StdUI_Tree_CloneAnchor _"+h),u=h,c.css({left:i.x,width:t,height:0}),void s.css({left:a.pageX+10,top:a.pageY+10}))},f=function(t){var i=o.parent(),s=r.parent(),a=i.data("node"),d=s.data("node");if(!s.contains(t.target)&&!c.is(t.target)||i.contains(s))return n=!1,h();if(!o.is(r)){var l=a.index(),p=d.index();switch(a.parent()._items.remove(l),u){case"before":d.parent()._items.insert(a,p),a.parent(d.parent()),i.insertBefore(s);break;case"after":d.parent()._items.insert(a,p),a.parent(d.parent()),i.insertAfter(s);break;case"in":d.expanded()||d.expand(!0),a.parent(d),isEmpty(d.D.ul)&&d._createChildNodes(),d.D.ul.append(i),d._items.push(a)}e.emit("itemPositionChange",[a,d.update(),u],!(n=!1)),h()}};return e[0].on("mouseenter","li._container_li > a._anchor",function(s){r=this,t=r.outerWidth(),i=r.position(),d=e[0].offset(),!n&&this.mouse({auto:!1,up:function(e){Std.dom(document).off("mousemove",m),n&&f(e)},down:function(e){var t=e.target.nodeName;"IMG"===t&&e.preventDefault(),1===e.which&&"INPUT"!==t&&(r=o=this,Std.dom(document).on("mousemove",m))}},s)}),e},initContextMenu:function(){var e=this,t=e.opts,n=null,i=function(e){n[0].contains(e.target)||n.hide()};t.itemContextMenu&&e[0].on("contextmenu","li._container_li > a._anchor",function(o){var s=Std.plugin("contextMenu");n||(e.once("remove",function(){n.remove(),n=null,Std.dom(document).off("mousedown",i)}),n=Std.ui("Menu",Std.extend({renderTo:"body",visible:!1,css:{position:"absolute"}},t.itemContextMenu)),n.on("itemPress",function(){n.hide()}),Std.dom(document).on("mousedown",i)),n.show(),s.move(n,o.pageX,o.pageY,"body"),o.stopFire(),o.preventDefault()})},initCheckboxEvents:function(){var e=this;return e[0].on("mouseenter","i._checkbox",e._checkboxEvents=function(e){var t=this.parent("li._container_li"),n=t.data("node");this.mouse({auto:!1,click:function(){n.checked(!n.checked())},dblclick:function(e){e.stopPropagation()}},e)}),e},initEvents:function(){var e=this;return e[0].unselect(!0).on("mouseenter","i._hand",function(e){var t=this.parent(),n=t.data("node");this.mouse({auto:!1,click:function(){n.expand(!n.expanded())}},e)}).on("mouseenter","li._container_li > a._anchor",function(t){e.anchorMouseEvents(this,t)}),e},updateStyle:function(){var e=this,t={},n=e.itemHeight();return t[".StdUI_Tree.StdUI_"+e.objectName]={">":{"ul > li._container_li":{marginLeft:0}}," ":{"input._input":{height:n-2+"px",lineHeight:n-2+"px"},"i._checkbox":{margin:(n-16)/2+"px"},"i._hand":{margin:(n-12)/2+2+"px"},"i._icon":{width:n-2+"px",height:n-2+"px"},"li._container_li":{marginLeft:n+"px"},"a._anchor":{height:n+"px",lineHeight:n+"px"}}},e._CSSStyle.clear().append(t),e},updateLines:function(){}},"public":{selectionMode:function(e){return this.opt("selectionMode",e,function(){this.emit("selectionModeChange",e)})},editable:function(e){return this.opt("editable",e)},itemHeight:function(e){return this.opt("itemHeight",e,function(){this.renderState&&this.updateStyle()})},dataSource:function(e){return this.opt("dataSource",e,function(){this.reload()})},checkable:function(e){return this.opt("checkable",e,function(){e!==!0||isFunction(this._checkboxEvents)||this.initCheckboxEvents()})},expandAll:function(){var e=this;return Std.each(e._items,function(e,t){t.expandAll()}),e},collapseAll:function(){var e=this;return Std.each(e._items,function(e,t){t.collapseAll()}),e},lines:function(e){return this.opt("lines",e,function(){this.updateLines()})},map:function(e,t){var n=this,i=n._IDMap;if(void 0===e)return i;if(isFunction(e))Std.each(i,function(t,n){e(t,n)});else{if(void 0===t)return i[e];i[e]=t}return n},count:function(){var e=this,t=e.opts;return e._items?e._items.length:t.items?t.items.length:0},types:Std.func(function(e,t){var n=this,i=n._types;return isString(e)&&void 0===t?i[e]:void(i[e]=Std.extend({},t))},{each:[isArray,isObject]}),insertBefore:function(e,t){var n=this,i=n.createTreeItem(e),o=n._items.indexOf(t);return i.insertTo(n[1],o),n._items.insert(i,o),n},insertAfter:function(e,t){var n=this,i=n.createTreeItem(e),o=n._items.indexOf(t);return-1!==o&&o++,i.insertTo(n[1],o),n._items.insert(i,o),n},insert:function(e,t){var n=this,i=n.createTreeItem(e);if(void 0===t)i.insertTo(n[1]),n._items.push(i);else if(isNumber(t))i.insertTo(n[1],t),n._items.insert(i,t);else if(isObject(t)){var o=n._items.indexOf(t);-1===o?(i.insertTo(n[1]),n._items.push(i)):(i.insertTo(n[1],o),n._items.insert(i,o))}return n},append:Std.func(function(e){this.insert(e)},{each:[isArray]}),reload:function(e){var t=this,n=t.opts,i=n.dataSource,o=i.read;return i&&"ajax"===i.type&&isObject(o)&&Std.ajax.json({url:o.url,data:Std.extend(o.data||{},e),type:o.type||"get",success:function(e){t.clear(),t.append(Std.mold.dataPath(e,o.dataPath)),t.emit("dataSourceLoad",e)}}),t},clearSelected:function(e){var t=this;return void 0===e&&(Std.each(t._selectedItems,function(e,t){t.opts.selected=!1,t.D.anchor.removeClass("selected")}),t._selectedItems.clear()),t},clearChecked:function(e){var t=this;return void 0===e&&(Std.each(t._checkedItems,function(e,t){t.opts.checked=!1,t.D.checkbox.removeClass("checked")}),t._checkedItems.clear()),t},clear:function(){var e=this;return e[1].clear(),e._items.clear(),e.clearChecked(),e.clearSelected(),Object.clear(e._IDMap),e.emit("clear")}},main:function(e,t){e[0].addClass("StdUI_"+e.objectName).append(e[1]=newDom("ul","_container_ul")),e._types={},e._items=[],e._IDMap={},e._checkedItems=[],e._selectedItems=[],e._CSSStyle=new Std.css,t.types&&e.types(t.types),t.items&&e.append(t.items),e.call_opts({dataSource:null},!0),e.initContextMenu()}}});